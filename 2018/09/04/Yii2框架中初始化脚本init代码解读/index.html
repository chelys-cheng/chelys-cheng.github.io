<!DOCTYPE html>
<html lang="zh_CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="Yii2框架中初始化脚本init代码解读"/>




  <meta name="keywords" content="PHP, Yii2, 程扣扣的博客" />










  <link rel="alternate" href="/default" title="程扣扣的博客">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.8.0" />



<link rel="canonical" href="http://yoursite.com/2018/09/04/Yii2框架中初始化脚本init代码解读/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.8.0" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"程扣扣的博客","subtitle":null,"description":null,"author":"程扣扣","language":"zh_CN","timezone":"Asia/Shanghai","url":"http://yoursite.com","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":true,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":true,"line_number":true,"tab_replace":null,"hljs":true,"first_line_number":"always1"},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":{"color":"Mint Green","toc":true,"fancybox":true,"pjax":true},"deploy":{"type":"git","repo":"git@github.com:chelys-cheng/chelys-cheng.github.io","branch":"master"},"ignore":[],"keywords":null,"index_generator":{"per_page":10,"order_by":"-date","path":""},"search":{"path":"search.json","field":"post"},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"since":"start - current","favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","Categories":"/categories","About":"/about"},"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc-sa/4.0/\" target=\"_blank\">署名-非商业性使用-相同方式共享 4.0 国际</a>"},"reward":{"enable":false,"qrCode":{"wechat":"/image/reward/wechat.png","alipay":"/image/reward/alipay.png"}},"social":{"email":"mailto:chelys@163.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/chelys-cheng","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":null,"app_key":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":null,"changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.8.0"};
</script>

    <title> Yii2框架中初始化脚本init代码解读 - 程扣扣的博客 </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">程扣扣的博客</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">程扣扣的博客</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Yii2框架中初始化脚本init代码解读
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-04
        </span>
        
          <div class="post-category">
            
              <a href="/categories/PHP/">PHP</a>
            
              <a href="/categories/PHP/Yii2/">Yii2</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        <p>代码是从最新的<a href="https://github.com/yiisoft/yii2/releases/download/2.0.15/yii-advanced-app-2.0.15.tgz" target="_blank" rel="noopener">yii-advanced-app-2.0.15.tgz</a>中直接获取，加以注释。</p>
<p>详情看代码注释：</p>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#!/usr/bin/env php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**<br> * Yii Application Initialization Tool<br> *<br> * In order to run in non-interactive mode:<br> *<br> * init --env=Development --overwrite=n<br> */</span><br><span class="hljs-keyword">if</span> (!extension_loaded(<span class="hljs-string">'openssl'</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">'The OpenSSL PHP extension is required by Yii2.'</span>);<br>&#125;<br><br><span class="hljs-comment">// 用于获取init后面的参数</span><br>$params = getParams();<br>$root = str_replace(<span class="hljs-string">'\\'</span>, <span class="hljs-string">'/'</span>, <span class="hljs-keyword">__DIR__</span>);<br><span class="hljs-comment">// 从`$root/environments/index.php`获取需要处理的文件列表</span><br>$envs = <span class="hljs-keyword">require</span> <span class="hljs-string">"$root/environments/index.php"</span>;<br><span class="hljs-comment">// 两个一级键值是[Development]和[Production]</span><br>$envNames = array_keys($envs);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">"Yii Application Initialization Tool v1.0\n\n"</span>;<br><br>$envName = <span class="hljs-keyword">null</span>;<br><span class="hljs-comment">// 可以接受不带--env参数，或者--env=1</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($params[<span class="hljs-string">'env'</span>]) || $params[<span class="hljs-string">'env'</span>] === <span class="hljs-string">'1'</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Which environment do you want the application to be initialized in?\n\n"</span>;<br>    <span class="hljs-keyword">foreach</span> ($envNames <span class="hljs-keyword">as</span> $i =&gt; $name) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"  [$i] $name\n"</span>;<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  Your choice [0-"</span> . (count($envs) - <span class="hljs-number">1</span>) . <span class="hljs-string">', or "q" to quit] '</span>;<br>    <span class="hljs-comment">// 从获取输入</span><br>    $answer = trim(fgets(STDIN));<br>    <span class="hljs-comment">// bool ctype_digit ( string $text ) 做纯数字检测</span><br>    <span class="hljs-keyword">if</span> (!ctype_digit($answer) || !in_array($answer, range(<span class="hljs-number">0</span>, count($envs) - <span class="hljs-number">1</span>))) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  Quit initialization.\n"</span>;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">// 如果是合法的环境，则往下初始化环境</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($envNames[$answer])) &#123;<br>        $envName = $envNames[$answer];<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;    <br><span class="hljs-comment">// 如果不是if的两种情况，则直接往下检查环境</span><br>    $envName = $params[<span class="hljs-string">'env'</span>];<br>&#125;<br><span class="hljs-comment">// 非[Development]或[Production]，报错</span><br><span class="hljs-keyword">if</span> (!in_array($envName, $envNames)) &#123;<br>    $envsList = implode(<span class="hljs-string">', '</span>, $envNames);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  $envName is not a valid environment. Try one of the following: $envsList. \n"</span>;<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">2</span>);<br>&#125;<br><span class="hljs-comment">// 从`$envs`中抽取用户选择的环境[Development]或[Production]</span><br>$env = $envs[$envName];<br><br><span class="hljs-comment">// 如果用户并非预输入了确定的环境，则二次询问用户</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($params[<span class="hljs-string">'env'</span>])) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  Initialize the application under '&#123;$envNames[$answer]&#125;' environment? [yes|no] "</span>;<br>    $answer = trim(fgets(STDIN));<br>    <span class="hljs-comment">// 只检查单词第一位是否是`y`，所以随意yadbfda都可以吧。实测可以。</span><br>    <span class="hljs-keyword">if</span> (strncasecmp($answer, <span class="hljs-string">'y'</span>, <span class="hljs-number">1</span>)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  Quit initialization.\n"</span>;<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  Start initialization ...\n\n"</span>;<br><span class="hljs-comment">// `$env['path']`中，两种情形下分别是`dev`和`prod`</span><br>$files = getFileList(<span class="hljs-string">"$root/environments/&#123;$env['path']&#125;"</span>);<br><span class="hljs-comment">// 如果有`skipFiles`键，则将里面的文件列表</span><br><span class="hljs-comment">// 则将这些文件，与对应环境[dev]或者[prod]文件夹中的文件进行剔除</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($env[<span class="hljs-string">'skipFiles'</span>])) &#123;<br>    $skipFiles = $env[<span class="hljs-string">'skipFiles'</span>];<br>    array_walk($skipFiles, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(&amp;$value)</span> <span class="hljs-title">use</span><span class="hljs-params">($env, $root)</span> </span>&#123; $value = <span class="hljs-string">"$root/$value"</span>; &#125;);<br>    $files = array_diff($files, array_intersect_key($env[<span class="hljs-string">'skipFiles'</span>], array_filter($skipFiles, <span class="hljs-string">'file_exists'</span>)));<br>&#125;<br>$all = <span class="hljs-keyword">false</span>;<br><span class="hljs-comment">// 将处理后的文件，复制到对应的路径中</span><br><span class="hljs-keyword">foreach</span> ($files <span class="hljs-keyword">as</span> $file) &#123;<br>    <span class="hljs-keyword">if</span> (!copyFile($root, <span class="hljs-string">"environments/&#123;$env['path']&#125;/$file"</span>, $file, $all, $params)) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 二级键中，除了`path`用于标识环境文件夹</span><br><span class="hljs-comment">// 其余的均是回调函数名</span><br>$callbacks = [<span class="hljs-string">'setCookieValidationKey'</span>, <span class="hljs-string">'setWritable'</span>, <span class="hljs-string">'setExecutable'</span>, <span class="hljs-string">'createSymlink'</span>];<br><span class="hljs-keyword">foreach</span> ($callbacks <span class="hljs-keyword">as</span> $callback) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($env[$callback])) &#123;<br>        $callback($root, $env[$callback]);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  ... initialization completed.\n\n"</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFileList</span><span class="hljs-params">($root, $basePath = <span class="hljs-string">''</span>)</span><br></span>&#123;<br>    $files = [];<br>    $handle = opendir($root);<br>    <span class="hljs-keyword">while</span> (($path = readdir($handle)) !== <span class="hljs-keyword">false</span>) &#123;<br>        <span class="hljs-comment">// 忽略`.git`|'.svn'|'.'|'..'`四种路径</span><br>        <span class="hljs-keyword">if</span> ($path === <span class="hljs-string">'.git'</span> || $path === <span class="hljs-string">'.svn'</span> || $path === <span class="hljs-string">'.'</span> || $path === <span class="hljs-string">'..'</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        $fullPath = <span class="hljs-string">"$root/$path"</span>;<br>        $relativePath = $basePath === <span class="hljs-string">''</span> ? $path : <span class="hljs-string">"$basePath/$path"</span>;<br>        <span class="hljs-keyword">if</span> (is_dir($fullPath)) &#123;<br>            $files = array_merge($files, getFileList($fullPath, $relativePath));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            $files[] = $relativePath;<br>        &#125;<br>    &#125;<br>    closedir($handle);<br>    <span class="hljs-keyword">return</span> $files;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copyFile</span><span class="hljs-params">($root, $source, $target, &amp;$all, $params)</span><br></span>&#123;<br>    <span class="hljs-comment">// 如果源文件不存在，则结束程序</span><br>    <span class="hljs-keyword">if</span> (!is_file($root . <span class="hljs-string">'/'</span> . $source)) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"       skip $target ($source not exist)\n"</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>    <span class="hljs-comment">// 如果目标文件存在</span><br>    <span class="hljs-keyword">if</span> (is_file($root . <span class="hljs-string">'/'</span> . $target)) &#123;<br>        <span class="hljs-comment">// 如果目标文件与源文件内容相同，则直接返回文件未改变</span><br>        <span class="hljs-keyword">if</span> (file_get_contents($root . <span class="hljs-string">'/'</span> . $source) === file_get_contents($root . <span class="hljs-string">'/'</span> . $target)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"  unchanged $target\n"</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// $all默认为`false`，不过会随着选择和最开始的参数，而发生变化</span><br>        <span class="hljs-keyword">if</span> ($all) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"  overwrite $target\n"</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"      exist $target\n"</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"            ...overwrite? [Yes|No|All|Quit] "</span>;<br><br>            <span class="hljs-comment">// 先判断是否在最开始带了`--overwrite=n`参数，带则依据最初的参数优先，否则读取用户输入</span><br>            $answer = !<span class="hljs-keyword">empty</span>($params[<span class="hljs-string">'overwrite'</span>]) ? $params[<span class="hljs-string">'overwrite'</span>] : trim(fgets(STDIN));<br>            <span class="hljs-keyword">if</span> (!strncasecmp($answer, <span class="hljs-string">'q'</span>, <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-comment">// 如果参数是`q`，则直接跳过覆写的文件</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (!strncasecmp($answer, <span class="hljs-string">'y'</span>, <span class="hljs-number">1</span>)) &#123;<br>                    <span class="hljs-comment">// 选择为`y`的时候，只是当前文件覆写，后面还会询问</span><br>                    <span class="hljs-keyword">echo</span> <span class="hljs-string">"  overwrite $target\n"</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!strncasecmp($answer, <span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>)) &#123;<br>                        <span class="hljs-comment">// 当选项为`a`，后面的文件直接就全部覆写了</span><br>                        <span class="hljs-keyword">echo</span> <span class="hljs-string">"  overwrite $target\n"</span>;<br>                        $all = <span class="hljs-keyword">true</span>;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-comment">// 其他任意键均跳过</span><br>                        <span class="hljs-keyword">echo</span> <span class="hljs-string">"       skip $target\n"</span>;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 将已有文件覆写到旧文件中</span><br>        file_put_contents($root . <span class="hljs-string">'/'</span> . $target, file_get_contents($root . <span class="hljs-string">'/'</span> . $source));<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"   generate $target\n"</span>;<br>    <span class="hljs-comment">// 新建文件夹</span><br>    <span class="hljs-comment">// 【注】文件操作，屏蔽了错误提示</span><br>    @mkdir(dirname($root . <span class="hljs-string">'/'</span> . $target), <span class="hljs-number">0777</span>, <span class="hljs-keyword">true</span>);<br>    <span class="hljs-comment">// 生成文件</span><br>    file_put_contents($root . <span class="hljs-string">'/'</span> . $target, file_get_contents($root . <span class="hljs-string">'/'</span> . $source));<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getParams</span><span class="hljs-params">()</span><br></span>&#123;<br>    $rawParams = [];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'argv'</span>])) &#123;<br>        $rawParams = $_SERVER[<span class="hljs-string">'argv'</span>];<br>        array_shift($rawParams);<br>    &#125;<br><br>    $params = [];<br>    <span class="hljs-keyword">foreach</span> ($rawParams <span class="hljs-keyword">as</span> $param) &#123;<br>        <span class="hljs-comment">// 匹配--env=1类似格式</span><br>        <span class="hljs-comment">// 可用参数选项`init --env=Development --overwrite=n`</span><br>        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/^--(\w+)(=(.*))?$/'</span>, $param, $matches)) &#123;<br>            $name = $matches[<span class="hljs-number">1</span>];<br>            $params[$name] = <span class="hljs-keyword">isset</span>($matches[<span class="hljs-number">3</span>]) ? $matches[<span class="hljs-number">3</span>] : <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            $params[] = $param;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> $params;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setWritable</span><span class="hljs-params">($root, $paths)</span><br></span>&#123;<br>    <span class="hljs-keyword">foreach</span> ($paths <span class="hljs-keyword">as</span> $writable) &#123;<br>        <span class="hljs-keyword">if</span> (is_dir(<span class="hljs-string">"$root/$writable"</span>)) &#123;<br>            <span class="hljs-comment">// 【注】文件操作，屏蔽了错误提示</span><br>            <span class="hljs-keyword">if</span> (@chmod(<span class="hljs-string">"$root/$writable"</span>, <span class="hljs-number">0777</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">"      chmod 0777 $writable\n"</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                printError(<span class="hljs-string">"Operation chmod not permitted for directory $writable."</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            printError(<span class="hljs-string">"Directory $writable does not exist."</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setExecutable</span><span class="hljs-params">($root, $paths)</span><br></span>&#123;<br>    <span class="hljs-keyword">foreach</span> ($paths <span class="hljs-keyword">as</span> $executable) &#123;<br>        <span class="hljs-keyword">if</span> (file_exists(<span class="hljs-string">"$root/$executable"</span>)) &#123;<br>            <span class="hljs-comment">// 【注】文件操作，屏蔽了错误提示</span><br>            <span class="hljs-keyword">if</span> (@chmod(<span class="hljs-string">"$root/$executable"</span>, <span class="hljs-number">0755</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">"      chmod 0755 $executable\n"</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                printError(<span class="hljs-string">"Operation chmod not permitted for $executable."</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            printError(<span class="hljs-string">"$executable does not exist."</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCookieValidationKey</span><span class="hljs-params">($root, $paths)</span><br></span>&#123;<br>    <span class="hljs-keyword">foreach</span> ($paths <span class="hljs-keyword">as</span> $file) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">"   generate cookie validation key in $file\n"</span>;<br>        $file = $root . <span class="hljs-string">'/'</span> . $file;<br>        $length = <span class="hljs-number">32</span>;<br>        <span class="hljs-comment">// openssl_random_pseudo_bytes(int $length [, bool &amp;$crypto_strong ]) — 生成一个伪随机字节串</span><br>        $bytes = openssl_random_pseudo_bytes($length);<br>        <span class="hljs-comment">// 生成的32位随机字节串，在用base64编码，取32位</span><br>        <span class="hljs-comment">// 再分别将字符串中的 '+'=&gt;'_' , '/'=&gt;'-' , '='=&gt;'.' 一一对应进行替换</span><br>        $key = strtr(substr(base64_encode($bytes), <span class="hljs-number">0</span>, $length), <span class="hljs-string">'+/='</span>, <span class="hljs-string">'_-.'</span>);<br>        <span class="hljs-comment">// 对内容进行替换，即生成了`cookieValidationKey`的值</span><br>        $content = preg_replace(<span class="hljs-string">'/(("|\')cookieValidationKey("|\')\s*=&gt;\s*)(""|\'\')/'</span>, <span class="hljs-string">"\\1'$key'"</span>, file_get_contents($file));<br>        file_put_contents($file, $content);<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 建立符号连接</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createSymlink</span><span class="hljs-params">($root, $links)</span><br></span>&#123;<br>    <span class="hljs-keyword">foreach</span> ($links <span class="hljs-keyword">as</span> $link =&gt; $target) &#123;<br>        <span class="hljs-comment">//first removing folders to avoid errors if the folder already exists</span><br>        @rmdir($root . <span class="hljs-string">"/"</span> . $link);<br>        <span class="hljs-comment">//next removing existing symlink in order to update the target</span><br>        <span class="hljs-keyword">if</span> (is_link($root . <span class="hljs-string">"/"</span> . $link)) &#123;<br>            @unlink($root . <span class="hljs-string">"/"</span> . $link);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (@symlink($root . <span class="hljs-string">"/"</span> . $target, $root . <span class="hljs-string">"/"</span> . $link)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">"      symlink $root/$target $root/$link\n"</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            printError(<span class="hljs-string">"Cannot create symlink $root/$target $root/$link."</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**<br> * Prints error message.<br> * <span class="hljs-doctag">@param</span> string $message message<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printError</span><span class="hljs-params">($message)</span><br></span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">"\n  "</span> . formatMessage(<span class="hljs-string">"Error. $message"</span>, [<span class="hljs-string">'fg-red'</span>]) . <span class="hljs-string">" \n"</span>;<br>&#125;<br><br><span class="hljs-comment">/**<br> * Returns true if the stream supports colorization. ANSI colors are disabled if not supported by the stream.<br> *<br> * - windows without ansicon<br> * - not tty consoles<br> *<br> * <span class="hljs-doctag">@return</span> boolean true if the stream supports ANSI colors, otherwise false.<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ansiColorsSupported</span><span class="hljs-params">()</span><br></span>&#123;<br>    <span class="hljs-keyword">return</span> DIRECTORY_SEPARATOR === <span class="hljs-string">'\\'</span><br>        ? getenv(<span class="hljs-string">'ANSICON'</span>) !== <span class="hljs-keyword">false</span> || getenv(<span class="hljs-string">'ConEmuANSI'</span>) === <span class="hljs-string">'ON'</span><br>        : function_exists(<span class="hljs-string">'posix_isatty'</span>) &amp;&amp; @posix_isatty(STDOUT);<br>&#125;<br><br><span class="hljs-comment">/**<br> * Get ANSI code of style.<br> * <span class="hljs-doctag">@param</span> string $name style name<br> * <span class="hljs-doctag">@return</span> integer ANSI code of style.<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStyleCode</span><span class="hljs-params">($name)</span><br></span>&#123;<br>    $styles = [<br>        <span class="hljs-string">'bold'</span> =&gt; <span class="hljs-number">1</span>,<br>        <span class="hljs-string">'fg-black'</span> =&gt; <span class="hljs-number">30</span>,<br>        <span class="hljs-string">'fg-red'</span> =&gt; <span class="hljs-number">31</span>,<br>        <span class="hljs-string">'fg-green'</span> =&gt; <span class="hljs-number">32</span>,<br>        <span class="hljs-string">'fg-yellow'</span> =&gt; <span class="hljs-number">33</span>,<br>        <span class="hljs-string">'fg-blue'</span> =&gt; <span class="hljs-number">34</span>,<br>        <span class="hljs-string">'fg-magenta'</span> =&gt; <span class="hljs-number">35</span>,<br>        <span class="hljs-string">'fg-cyan'</span> =&gt; <span class="hljs-number">36</span>,<br>        <span class="hljs-string">'fg-white'</span> =&gt; <span class="hljs-number">37</span>,<br>        <span class="hljs-string">'bg-black'</span> =&gt; <span class="hljs-number">40</span>,<br>        <span class="hljs-string">'bg-red'</span> =&gt; <span class="hljs-number">41</span>,<br>        <span class="hljs-string">'bg-green'</span> =&gt; <span class="hljs-number">42</span>,<br>        <span class="hljs-string">'bg-yellow'</span> =&gt; <span class="hljs-number">43</span>,<br>        <span class="hljs-string">'bg-blue'</span> =&gt; <span class="hljs-number">44</span>,<br>        <span class="hljs-string">'bg-magenta'</span> =&gt; <span class="hljs-number">45</span>,<br>        <span class="hljs-string">'bg-cyan'</span> =&gt; <span class="hljs-number">46</span>,<br>        <span class="hljs-string">'bg-white'</span> =&gt; <span class="hljs-number">47</span>,<br>    ];<br>    <span class="hljs-keyword">return</span> $styles[$name];<br>&#125;<br><br><span class="hljs-comment">/**<br> * Formats message using styles if STDOUT supports it.<br> * <span class="hljs-doctag">@param</span> string $message message<br> * <span class="hljs-doctag">@param</span> string[] $styles styles<br> * <span class="hljs-doctag">@return</span> string formatted message.<br> */</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatMessage</span><span class="hljs-params">($message, $styles)</span><br></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($styles) || !ansiColorsSupported()) &#123;<br>        <span class="hljs-keyword">return</span> $message;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> sprintf(<span class="hljs-string">"\x1b[%sm"</span>, implode(<span class="hljs-string">';'</span>, array_map(<span class="hljs-string">'getStyleCode'</span>, $styles))) . $message . <span class="hljs-string">"\x1b[0m"</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://yoursite.com">程扣扣</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://yoursite.com/2018/09/04/Yii2框架中初始化脚本init代码解读/">http://yoursite.com/2018/09/04/Yii2框架中初始化脚本init代码解读/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/PHP/">PHP</a>
            
              <a href="/tags/Yii2/">Yii2</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/2018/09/04/Yii2框架初始化前，添加api应用/">
        <span class="next-text nav-default">Yii2框架初始化前，添加api应用</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:mailto:chelys@163.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/chelys-cheng" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      start - current - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">程扣扣</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.8.0"></script>

  </body>
</html>
